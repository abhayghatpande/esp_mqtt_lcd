

#include "ets_sys.h"
#include "osapi.h"
#include "gpio.h"
#include "osapi.h"
#include "os_type.h"
#include "user_config.h"
#include "user_interface.h"
#include "driver/stdout.h"
#include "driver/pcd8544.h"

static uint8_t openhardware_logo[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xe0,0xe0,0xe0,0xc0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0xf0,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0xc0,0xe0,0xe0,0xe0,0xe0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0e,0x1f,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x3f,0x1e,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0xc0,0xc0,0xe0,0xe0,0xe0,0xf0,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x3f,0x1f,0x1f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x1f,0x3f,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0xf0,0xe0,0xe0,0xe0,0xc0,0xc0,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7f,0x7f,0x7f,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe1,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xe1,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x7f,0x7f,0x7f,0x7f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x83,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x7f,0x1e,0x00,0x00,0x00,0x00,0x00,0x06,0x1e,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xcf,0x83,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0e,0x1f,0x3f,0x7f,0xff,0xff,0xff,0x7f,0x7f,0x3f,0x3f,0x1f,0x3f,0x3f,0x3f,0x0f,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x0f,0x3f,0x3f,0x3f,0x1f,0x3f,0x3f,0x7f,0xff,0xff,0xff,0xff,0x3f,0x3f,0x1e,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

#define user_procLcdUpdatePeriod      1000
static volatile os_timer_t lcd_timer;
static PCD8544_Settings pcd8544_settings;

void user_init(void);
static void loop(os_event_t *events);

//Main code function
static void ICACHE_FLASH_ATTR
loop(os_event_t *events) {
  static bool toggle = true;
  static uint32_t loopIterations = 0;
  loopIterations+=1;
  if (loopIterations < 2) {
    // I wonder why the calls to initLCD in user_init doesn't 'take'
    PCD8544_init(&pcd8544_settings); // You don't have to call PCD8544_init here, PCD8544_initLCD is enough.
                                     // But this way you will be able to see eventual error messages
    os_delay_us(50000);
    PCD8544_lcdImage(openhardware_logo);
    os_printf("Initiating display: %d\n\r", loopIterations);
  } else if (loopIterations == 2){
    PCD8544_lcdClear();
  } else {
    os_printf("Updating display\n\r");
    // Draw a Box
    PCD8544_drawLine();
    int a=0;
    PCD8544_gotoXY(17,1);
    // Put text in Box
    PCD8544_lcdString("ESP8266");
    PCD8544_gotoXY(24,3);
    if (toggle){
      PCD8544_lcdCharacter('H');
      PCD8544_lcdCharacter('E');
      PCD8544_lcdCharacter('L');
      PCD8544_lcdCharacter('L');
      PCD8544_lcdCharacter('O');
      PCD8544_lcdCharacter(' ');
      PCD8544_lcdCharacter('=');
      // Draw + at this position
      PCD8544_gotoXY(10,3);
      PCD8544_lcdCharacter('=');
      os_delay_us(50000);
    } else {
      PCD8544_gotoXY(24,3);
      PCD8544_lcdCharacter('h');
      PCD8544_lcdCharacter('e');
      PCD8544_lcdCharacter('l');
      PCD8544_lcdCharacter('l');
      PCD8544_lcdCharacter('o');
      PCD8544_lcdCharacter(' ');
      PCD8544_lcdCharacter('-');
      // Draw - at this position
      PCD8544_gotoXY(10,3);
      PCD8544_lcdCharacter('-');
      os_delay_us(50000);
    }
    toggle = !toggle;
  }
  os_timer_disarm(&lcd_timer);
  os_timer_arm(&lcd_timer, user_procLcdUpdatePeriod, 0);
}

//Init function 
void ICACHE_FLASH_ATTR
user_init(void)
{
  pcd8544_settings.lcdVop = 0xB1;
  pcd8544_settings.tempCoeff = 0x04;
  pcd8544_settings.biasMode = 0x14;
  pcd8544_settings.inverse = false;

  pcd8544_settings.resetPin = 4;
  pcd8544_settings.scePin = 5;
  //pcd8544_settings.resetPin = 0;
  //pcd8544_settings.scePin = 2;

  pcd8544_settings.dcPin = 12;
  pcd8544_settings.sdinPin = 13;
  pcd8544_settings.sclkPin = 14;

  //Set station mode
  wifi_set_opmode( NULL_MODE );

  // Make os_printf working again. Baud:115200,n,8,1
  stdoutInit();
  PCD8544_init(&pcd8544_settings);
  os_printf("System started\n\r");
  //Start os task
  os_timer_setfn(&lcd_timer, (os_timer_func_t*) loop, NULL);
  os_timer_arm(&lcd_timer, user_procLcdUpdatePeriod, 0);
}
